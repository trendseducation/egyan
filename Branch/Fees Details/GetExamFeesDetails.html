<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Exam Fees</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #4361ee;
            --secondary-color: #3f37c9;
            --success-color: #4cc9f0;
            --danger-color: #f72585;
            --warning-color: #f8961e;
            --light-color: #f8f9fa;
            --dark-color: #212529;
            --gray-color: #6c757d;
            --light-gray: #e9ecef;
            --border-radius: 12px;
            --box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            --transition: all 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            color: var(--dark-color);
            line-height: 1.6;
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            flex-wrap: wrap;
            gap: 20px;
        }

        .header-left h1 {
            font-size: 28px;
            color: var(--primary-color);
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .header-left h1 i {
            color: var(--secondary-color);
        }

        .header-left p {
            color: var(--gray-color);
            font-size: 16px;
            margin-top: 5px;
        }

        .stats-container {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .stat-card {
            background: white;
            padding: 15px 20px;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            display: flex;
            align-items: center;
            gap: 12px;
            min-width: 180px;
        }

        .stat-icon {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
            color: white;
        }

        .stat-icon.total {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
        }

        .stat-icon.courses {
            background: linear-gradient(135deg, #4cc9f0, #4895ef);
        }

        .stat-details h3 {
            font-size: 24px;
            font-weight: 700;
            color: var(--dark-color);
        }

        .stat-details p {
            color: var(--gray-color);
            font-size: 14px;
        }

        .main-content {
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            overflow: hidden;
            margin-bottom: 30px;
        }

        .table-header {
            padding: 20px 25px;
            border-bottom: 1px solid var(--light-gray);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .table-header h2 {
            font-size: 22px;
            color: var(--dark-color);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .table-header h2 i {
            color: var(--primary-color);
        }

        .search-filter {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .search-box {
            position: relative;
            min-width: 250px;
        }

        .search-box input {
            width: 100%;
            padding: 10px 15px 10px 40px;
            border: 1px solid var(--light-gray);
            border-radius: 8px;
            font-size: 15px;
            transition: var(--transition);
        }

        .search-box input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.1);
        }

        .search-box i {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--gray-color);
        }

        .table-container {
            overflow-x: auto;
            padding: 0;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
        }

        th {
            padding: 18px 15px;
            text-align: left;
            color: white;
            font-weight: 600;
            font-size: 15px;
        }

        tbody tr {
            border-bottom: 1px solid var(--light-gray);
            transition: var(--transition);
        }

        tbody tr:hover {
            background-color: rgba(67, 97, 238, 0.03);
        }

        td {
            padding: 16px 15px;
            font-size: 15px;
        }

        .amount-cell {
            font-weight: 600;
            color: var(--primary-color);
        }

        .action-cell {
            text-align: center;
        }

        .btn-edit {
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 6px;
            padding: 8px 16px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            transition: var(--transition);
        }

        .btn-edit:hover {
            background-color: var(--secondary-color);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .no-data {
            text-align: center;
            padding: 40px 20px;
            color: var(--gray-color);
            font-size: 16px;
        }

        .no-data i {
            font-size: 48px;
            margin-bottom: 15px;
            color: var(--light-gray);
        }

        .footer-info {
            text-align: center;
            padding: 20px;
            color: var(--gray-color);
            font-size: 14px;
            border-top: 1px solid var(--light-gray);
        }

        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            padding: 20px;
            opacity: 0;
            visibility: hidden;
            transition: var(--transition);
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal {
            background: white;
            border-radius: var(--border-radius);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            width: 100%;
            max-width: 700px;
            max-height: 90vh;
            overflow-y: auto;
            transform: translateY(20px);
            transition: transform 0.3s ease;
        }

        .modal-overlay.active .modal {
            transform: translateY(0);
        }

        .modal-header {
            padding: 20px 25px;
            border-bottom: 1px solid var(--light-gray);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h3 {
            font-size: 22px;
            color: var(--dark-color);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .modal-header h3 i {
            color: var(--primary-color);
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            color: var(--gray-color);
            cursor: pointer;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
        }

        .modal-close:hover {
            background-color: var(--light-gray);
            color: var(--dark-color);
        }

        .modal-body {
            padding: 25px;
        }

        /* Message Container */
        .message-container {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }

        .message-container.info {
            background-color: rgba(67, 97, 238, 0.1);
            border-left: 4px solid var(--primary-color);
            color: var(--dark-color);
        }

        .message-container.warning {
            background-color: rgba(248, 150, 30, 0.1);
            border-left: 4px solid var(--warning-color);
            color: var(--dark-color);
        }

        .message-container.success {
            background-color: rgba(76, 201, 240, 0.1);
            border-left: 4px solid var(--success-color);
            color: var(--dark-color);
        }

        .message-container.error {
            background-color: rgba(247, 37, 133, 0.1);
            border-left: 4px solid var(--danger-color);
            color: var(--dark-color);
        }

        .message-container.processing {
            background-color: rgba(108, 117, 125, 0.1);
            border-left: 4px solid var(--gray-color);
            color: var(--dark-color);
        }

        .message-content {
            display: flex;
            align-items: flex-start;
            gap: 10px;
        }

        .message-content i {
            font-size: 18px;
            margin-top: 2px;
        }

        .message-text {
            flex: 1;
        }

        .message-text h4 {
            font-size: 16px;
            margin-bottom: 5px;
            font-weight: 600;
        }

        .message-text p {
            font-size: 14px;
            color: var(--gray-color);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--dark-color);
            font-size: 15px;
        }

        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid var(--light-gray);
            border-radius: 8px;
            font-size: 15px;
            transition: var(--transition);
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.1);
        }

        .form-control:disabled {
            background-color: #f8f9fa;
            color: var(--gray-color);
            cursor: not-allowed;
            border-color: #e9ecef;
        }

        .form-hint {
            font-size: 12px;
            color: var(--gray-color);
            margin-top: 5px;
            font-style: italic;
        }

        .file-link {
            color: var(--primary-color);
            text-decoration: none;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            transition: var(--transition);
        }

        .file-link:hover {
            color: var(--secondary-color);
            text-decoration: underline;
        }

        .modal-footer {
            padding: 20px 25px;
            border-top: 1px solid var(--light-gray);
            display: flex;
            justify-content: flex-end;
            gap: 15px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: var(--transition);
            min-width: 120px;
        }

        .btn-update {
            background-color: var(--success-color);
            color: white;
        }

        .btn-update:hover {
            background-color: #3aa8d4;
            transform: translateY(-2px);
        }

        .btn-update:disabled {
            background-color: #a5d8e6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-delete {
            background-color: var(--danger-color);
            color: white;
        }

        .btn-delete:hover {
            background-color: #d1145a;
            transform: translateY(-2px);
        }

        .btn-delete:disabled {
            background-color: #f9a7c5;
            cursor: not-allowed;
            transform: none;
        }

        .btn-cancel {
            background-color: var(--light-gray);
            color: var(--dark-color);
        }

        .btn-cancel:hover {
            background-color: #d8d9da;
        }

        .btn-cancel:disabled {
            background-color: #e9ecef;
            cursor: not-allowed;
            transform: none;
        }

        /* Loading Animation */
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 40px;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid var(--light-gray);
            border-top: 5px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Toast Notification */
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: white;
            padding: 15px 20px;
            border-radius: var(--border-radius);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            gap: 12px;
            z-index: 1000;
            transform: translateY(100px);
            opacity: 0;
            transition: transform 0.3s ease, opacity 0.3s ease;
        }

        .toast.show {
            transform: translateY(0);
            opacity: 1;
        }

        .toast-icon {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 14px;
        }

        .toast-icon.success {
            background-color: var(--success-color);
        }

        .toast-icon.error {
            background-color: var(--danger-color);
        }

        .toast-content h4 {
            font-size: 16px;
            margin-bottom: 3px;
        }

        .toast-content p {
            font-size: 14px;
            color: var(--gray-color);
        }

        /* Mobile & Tablet Optimizations */
        @media (max-width: 1024px) {
            .table-header {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .search-filter {
                width: 100%;
            }
            
            .search-box {
                flex-grow: 1;
                min-width: unset;
            }
        }

        @media (max-width: 768px) {
            body {
                padding: 15px;
            }
            
            .header-left h1 {
                font-size: 24px;
            }
            
            .stat-card {
                min-width: 150px;
                padding: 12px 15px;
            }
            
            .stat-details h3 {
                font-size: 20px;
            }
            
            .table-header h2 {
                font-size: 20px;
            }
            
            th, td {
                padding: 14px 12px;
                font-size: 14px;
            }
            
            .btn-edit {
                padding: 6px 12px;
                font-size: 13px;
            }
            
            .modal-body {
                padding: 20px;
            }
            
            .modal-footer {
                flex-direction: column;
                gap: 10px;
            }
            
            .btn {
                width: 100%;
            }
        }

        @media (max-width: 480px) {
            header {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .stats-container {
                width: 100%;
                justify-content: space-between;
            }
            
            .stat-card {
                min-width: calc(50% - 10px);
                flex-direction: column;
                text-align: center;
                gap: 8px;
            }
            
            .stat-icon {
                width: 40px;
                height: 40px;
                font-size: 18px;
            }
            
            .search-box {
                width: 100%;
            }
            
            .search-filter {
                flex-direction: column;
                width: 100%;
            }
            
            table {
                min-width: 300px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="header-left">
                <h1><i class="fas fa-file-invoice-dollar"></i> Exam Fees Management</h1>
                <p>Manage and track exam fees, documents, and student records</p>
            </div>
            <div class="stats-container">
                <div class="stat-card">
                    <div class="stat-icon total">
                        <i class="fas fa-users"></i>
                    </div>
                    <div class="stat-details">
                        <h3 id="totalRecords">0</h3>
                        <p>Total Records</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon courses">
                        <i class="fas fa-graduation-cap"></i>
                    </div>
                    <div class="stat-details">
                        <h3>6</h3>
                        <p>Courses Available</p>
                    </div>
                </div>
            </div>
        </header>

        <div class="main-content">
            <div class="table-header">
                <h2><i class="fas fa-table"></i> Exam Fees Records</h2>
                <div class="search-filter">
                    <div class="search-box">
                        <i class="fas fa-search"></i>
                        <input type="text" id="searchInput" placeholder="Search by name...">
                    </div>
                </div>
            </div>
            
            <div class="table-container">
                <div class="loading" id="loadingIndicator">
                    <div class="loading-spinner"></div>
                </div>
                <table id="feesTable">
                    <thead>
                        <tr>
                            <th>SR. NO</th>
                            <th>Full Name</th>
                            <th>Amount</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody">
                        <!-- Data will be loaded here -->
                    </tbody>
                </table>
                <div class="no-data" id="noDataMessage" style="display: none;">
                    <i class="fas fa-database"></i>
                    <p>No exam fee records found.</p>
                </div>
            </div>
            
            <div class="footer-info">
                <p><i class="fas fa-info-circle"></i> Click on Edit button to view and modify record details</p>
            </div>
        </div>
    </div>

    <!-- Edit Modal -->
    <div class="modal-overlay" id="editModal">
        <div class="modal">
            <div class="modal-header">
                <h3><i class="fas fa-edit"></i> Edit Record</h3>
                <button class="modal-close" id="closeModal">&times;</button>
            </div>
            <div class="modal-body">
                <!-- Message Container -->
                <div class="message-container info" id="infoMessage">
                    <div class="message-content">
                        <i class="fas fa-info-circle"></i>
                        <div class="message-text">
                            <h4>Information</h4>
                            <p id="infoMessageText">Full Name cannot be edited as it's linked to the student's identity.</p>
                        </div>
                    </div>
                </div>
                
                <!-- Warning Message Container -->
                <div class="message-container warning" id="warningMessage">
                    <div class="message-content">
                        <i class="fas fa-exclamation-triangle"></i>
                        <div class="message-text">
                            <h4>Warning</h4>
                            <p id="warningMessageText"></p>
                        </div>
                    </div>
                </div>
                
                <!-- Success Message Container -->
                <div class="message-container success" id="successMessage">
                    <div class="message-content">
                        <i class="fas fa-check-circle"></i>
                        <div class="message-text">
                            <h4>Success</h4>
                            <p id="successMessageText"></p>
                        </div>
                    </div>
                </div>
                
                <!-- Error Message Container -->
                <div class="message-container error" id="errorMessage">
                    <div class="message-content">
                        <i class="fas fa-exclamation-circle"></i>
                        <div class="message-text">
                            <h4>Error</h4>
                            <p id="errorMessageText"></p>
                        </div>
                    </div>
                </div>
                
                <!-- Processing Message Container -->
                <div class="message-container processing" id="processingMessage">
                    <div class="message-content">
                        <i class="fas fa-spinner fa-spin"></i>
                        <div class="message-text">
                            <h4>Processing</h4>
                            <p id="processingMessageText"></p>
                        </div>
                    </div>
                </div>
                
                <!-- Update Success Message Container -->
                <div class="message-container success" id="updateSuccessMessage">
                    <div class="message-content">
                        <i class="fas fa-check-circle"></i>
                        <div class="message-text">
                            <h4>Update Successful</h4>
                            <p id="updateSuccessMessageText">Record has been updated successfully!</p>
                        </div>
                    </div>
                </div>
                
                <!-- Delete Success Message Container -->
                <div class="message-container success" id="deleteSuccessMessage">
                    <div class="message-content">
                        <i class="fas fa-check-circle"></i>
                        <div class="message-text">
                            <h4>Delete Successful</h4>
                            <p id="deleteSuccessMessageText">Record has been deleted successfully!</p>
                        </div>
                    </div>
                </div>
                
                <form id="editForm">
                    <input type="hidden" id="editRowNumber">
                    
                    <div class="form-group">
                        <label for="editSrNo">SR. NO</label>
                        <input type="text" id="editSrNo" class="form-control" disabled>
                    </div>
                    
                    <div class="form-group">
                        <label for="editDate">Date</label>
                        <input type="date" id="editDate" class="form-control">
                    </div>
                    
                    <div class="form-group">
                        <label for="editFullName">Full Name</label>
                        <input type="text" id="editFullName" class="form-control" disabled>
                        <small style="color: var(--gray-color); font-size: 13px; margin-top: 5px; display: block;">
                            <i class="fas fa-info-circle"></i> Full Name cannot be modified to maintain record integrity.
                        </small>
                    </div>
                    
                    <div class="form-group">
                        <label for="editCourse">Course</label>
                        <select id="editCourse" class="form-control">
                            <!-- Course options will be populated by JavaScript -->
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="editAmount">Amount</label>
                        <input type="number" id="editAmount" class="form-control" min="0" step="1">
                    </div>
                    
                    <div class="form-group">
                        <label for="editDocument">Document Name</label>
                        <select id="editDocument" class="form-control">
                            <option value="Aadhar Card">Aadhar Card</option>
                            <option value="Pan Card">Pan Card</option>
                            <option value="Passport">Passport</option>
                            <option value="Driving License">Driving License</option>
                        </select>
                    </div>
                    
                    <!-- Aadhar Card Number Field -->
                    <div class="form-group" id="aadharGroup">
                        <label for="editAadhar">Aadhar Card No:</label>
                        <input type="text" id="editAadhar" class="form-control" 
                               placeholder="Enter Aadhar card number" maxlength="14">
                        <div class="form-hint">Format: 1234 5678 9012 (12 digits)</div>
                    </div>
                    
                    <!-- Pan Card Number Field -->
                    <div class="form-group" id="panGroup">
                        <label for="editPan">Pan Card No:</label>
                        <input type="text" id="editPan" class="form-control" 
                               placeholder="Enter PAN card number" maxlength="10">
                        <div class="form-hint">Format: ABCDE1234F</div>
                    </div>
                    
                    <div class="form-group">
                        <label for="editFile">File</label>
                        <div id="editFile" class="form-control" style="background-color: transparent; border: none; padding: 0;">
                            <!-- File link will be displayed here -->
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-cancel" id="cancelEdit">Cancel</button>
                <button class="btn btn-update" id="updateRecord"><i class="fas fa-save"></i> Update</button>
                <button class="btn btn-delete" id="deleteRecord"><i class="fas fa-trash-alt"></i> Delete</button>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div class="toast" id="toast">
        <div class="toast-icon success">
            <i class="fas fa-check"></i>
        </div>
        <div class="toast-content">
            <h4>Success</h4>
            <p id="toastMessage">Record updated successfully</p>
        </div>
    </div>

    <script>
        /* üîß CONFIG */
        const scriptUrl = "https://script.google.com/macros/s/AKfycbylbF6GepY2XkkoVfPW-tW9aoJa6Ok86ciQMUPtJY328KcOYVckziNJBkiWSYwmnjTu/exec";
        const SPREADSHEET_ID = "17W3uI55kaecrshN3k5Fsd7XjMtsJeQen5GiSiz4qZis";
        const SHEET_NAME = "Exam_Fees_details";
        const FOLDER_ID = "1wzQqQkGNUa9yuxsJn9CXGNVmSu0IdbNL";
        /* ================= */

        let allData = []; // Store all data for filtering
        let currentEditRow = null; // Store current row being edited

        // DOM elements
        const searchInput = document.getElementById('searchInput');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const noDataMessage = document.getElementById('noDataMessage');
        const totalRecordsElement = document.getElementById('totalRecords');
        const toast = document.getElementById('toast');
        const editModal = document.getElementById('editModal');
        const closeModal = document.getElementById('closeModal');
        const cancelEdit = document.getElementById('cancelEdit');
        const updateRecordBtn = document.getElementById('updateRecord');
        const deleteRecordBtn = document.getElementById('deleteRecord');
        
        // Message containers
        const infoMessage = document.getElementById('infoMessage');
        const warningMessage = document.getElementById('warningMessage');
        const successMessage = document.getElementById('successMessage');
        const errorMessage = document.getElementById('errorMessage');
        const processingMessage = document.getElementById('processingMessage');
        const updateSuccessMessage = document.getElementById('updateSuccessMessage');
        const deleteSuccessMessage = document.getElementById('deleteSuccessMessage');
        
        const infoMessageText = document.getElementById('infoMessageText');
        const warningMessageText = document.getElementById('warningMessageText');
        const successMessageText = document.getElementById('successMessageText');
        const errorMessageText = document.getElementById('errorMessageText');
        const processingMessageText = document.getElementById('processingMessageText');
        const updateSuccessMessageText = document.getElementById('updateSuccessMessageText');
        const deleteSuccessMessageText = document.getElementById('deleteSuccessMessageText');
        const toastMessage = document.getElementById('toastMessage');
        
        // Form elements
        const editForm = document.getElementById('editForm');
        const editRowNumber = document.getElementById('editRowNumber');
        const editSrNo = document.getElementById('editSrNo');
        const editDate = document.getElementById('editDate');
        const editFullName = document.getElementById('editFullName');
        const editCourse = document.getElementById('editCourse');
        const editAmount = document.getElementById('editAmount');
        const editDocument = document.getElementById('editDocument');
        const editAadhar = document.getElementById('editAadhar');
        const editPan = document.getElementById('editPan');
        const aadharGroup = document.getElementById('aadharGroup');
        const panGroup = document.getElementById('panGroup');
        const editFile = document.getElementById('editFile');

        /* üîÅ Convert Sheet Date ‚Üí YYYY-MM-DD */
        function formatDateForInput(dateValue) {
            if (!dateValue) return "";
            
            // Check if date is already in YYYY-MM-DD format
            if (typeof dateValue === 'string' && dateValue.match(/^\d{4}-\d{2}-\d{2}$/)) {
                return dateValue;
            }
            
            try {
                const d = new Date(dateValue);
                if (isNaN(d.getTime())) {
                    // Try parsing as string if Date constructor fails
                    const parts = String(dateValue).split('/');
                    if (parts.length === 3) {
                        // Format: DD/MM/YYYY
                        const day = parts[0].padStart(2, '0');
                        const month = parts[1].padStart(2, '0');
                        const year = parts[2];
                        return `${year}-${month}-${day}`;
                    } else if (parts.length === 1 && dateValue.includes('-')) {
                        // Already in correct format or close
                        return dateValue;
                    }
                    return "";
                }
                
                const year = d.getFullYear();
                const month = String(d.getMonth() + 1).padStart(2, "0");
                const day = String(d.getDate()).padStart(2, "0");
                return `${year}-${month}-${day}`;
            } catch (error) {
                console.error("Date formatting error:", error, "Value:", dateValue);
                return "";
            }
        }

        /* Format currency */
        function formatCurrency(amount) {
            const numAmount = parseFloat(amount) || 0;
            return new Intl.NumberFormat('en-IN', {
                style: 'currency',
                currency: 'INR',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(numAmount);
        }

        /* Show/hide document number fields based on selection */
        function toggleDocumentFields(documentType) {
            // Hide both initially
            aadharGroup.style.display = 'none';
            panGroup.style.display = 'none';
            
            // Show relevant field
            if (documentType === 'Aadhar Card') {
                aadharGroup.style.display = 'block';
            } else if (documentType === 'Pan Card') {
                panGroup.style.display = 'block';
            }
            // For Passport and Driving License, no additional fields needed
        }

        /* Format Aadhar number as user types */
        if (editAadhar) {
            editAadhar.addEventListener('input', function(e) {
                let value = e.target.value.replace(/\D/g, ''); // Remove non-digits
                let formatted = '';
                
                // Format as XXXX XXXX XXXX
                for (let i = 0; i < value.length && i < 12; i++) {
                    if (i > 0 && i % 4 === 0) {
                        formatted += ' ';
                    }
                    formatted += value[i];
                }
                
                e.target.value = formatted;
            });
        }

        /* Format PAN number as user types */
        if (editPan) {
            editPan.addEventListener('input', function(e) {
                let value = e.target.value.toUpperCase(); // Convert to uppercase
                value = value.replace(/[^A-Z0-9]/g, ''); // Remove non-alphanumeric
                e.target.value = value;
            });
        }

        /* Show message in modal */
        function showModalMessage(type, title, message) {
            // Hide all messages first
            infoMessage.style.display = 'none';
            warningMessage.style.display = 'none';
            successMessage.style.display = 'none';
            errorMessage.style.display = 'none';
            processingMessage.style.display = 'none';
            updateSuccessMessage.style.display = 'none';
            deleteSuccessMessage.style.display = 'none';
            
            // Show the requested message
            switch(type) {
                case 'info':
                    infoMessageText.textContent = message;
                    infoMessage.style.display = 'block';
                    break;
                case 'warning':
                    warningMessageText.textContent = message;
                    warningMessage.style.display = 'block';
                    break;
                case 'success':
                    successMessageText.textContent = message;
                    successMessage.style.display = 'block';
                    break;
                case 'error':
                    errorMessageText.textContent = message;
                    errorMessage.style.display = 'block';
                    break;
                case 'processing':
                    processingMessageText.textContent = message;
                    processingMessage.style.display = 'block';
                    break;
                case 'update-success':
                    updateSuccessMessageText.textContent = message;
                    updateSuccessMessage.style.display = 'block';
                    break;
                case 'delete-success':
                    deleteSuccessMessageText.textContent = message;
                    deleteSuccessMessage.style.display = 'block';
                    break;
            }
        }

        /* Hide all modal messages */
        function hideModalMessages() {
            infoMessage.style.display = 'none';
            warningMessage.style.display = 'none';
            successMessage.style.display = 'none';
            errorMessage.style.display = 'none';
            processingMessage.style.display = 'none';
            updateSuccessMessage.style.display = 'none';
            deleteSuccessMessage.style.display = 'none';
        }

        /* Enable/Disable buttons */
        function setButtonsState(enabled) {
            updateRecordBtn.disabled = !enabled;
            deleteRecordBtn.disabled = !enabled;
            cancelEdit.disabled = !enabled;
        }

        /* Show toast notification */
        function showToast(message, type = 'success') {
            const toastIcon = toast.querySelector('.toast-icon');
            const toastTitle = toast.querySelector('.toast-content h4');
            
            toastMessage.textContent = message;
            
            if (type === 'success') {
                toastIcon.className = 'toast-icon success';
                toastIcon.innerHTML = '<i class="fas fa-check"></i>';
                toastTitle.textContent = 'Success';
            } else {
                toastIcon.className = 'toast-icon error';
                toastIcon.innerHTML = '<i class="fas fa-exclamation"></i>';
                toastTitle.textContent = 'Error';
            }
            
            toast.classList.add('show');
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        /* Populate course dropdown */
        function populateCourseDropdown() {
            const courses = [
                "PC Operation (Basic)",
                "Tally with GST",
                "Advance Excel",
                "Basic + Tally",
                "Basic + Advance Excel",
                "Tally + Advance Excel"
            ];
            
            if (editCourse) {
                editCourse.innerHTML = '';
                courses.forEach(course => {
                    const option = document.createElement('option');
                    option.value = course;
                    option.textContent = course;
                    editCourse.appendChild(option);
                });
            }
        }

        /* Validate form data */
        function validateFormData() {
            const date = editDate.value;
            const course = editCourse.value;
            const amount = editAmount.value;
            const document = editDocument.value;
            const aadhar = editAadhar.value;
            const pan = editPan.value;
            
            // Check if all required fields are filled
            if (!date || !course || !amount || !document) {
                showModalMessage('error', 'Validation Error', 'Please fill in all required fields.');
                return false;
            }
            
            // Check if amount is valid
            const amountNum = parseFloat(amount);
            if (isNaN(amountNum) || amountNum <= 0) {
                showModalMessage('error', 'Validation Error', 'Amount must be a valid number greater than 0.');
                return false;
            }
            
            // Validate Aadhar if selected
            if (document === 'Aadhar Card') {
                const aadharValue = aadhar.replace(/\s/g, ''); // Remove spaces
                if (!aadharValue || aadharValue.length !== 12) {
                    showModalMessage('error', 'Validation Error', 'Aadhar card must be 12 digits in XXXX XXXX XXXX format.');
                    return false;
                }
                if (!/^\d+$/.test(aadharValue)) {
                    showModalMessage('error', 'Validation Error', 'Aadhar card must contain only numbers.');
                    return false;
                }
            }
            
            // Validate PAN if selected
            if (document === 'Pan Card') {
                const panValue = pan;
                if (!panValue || panValue.length !== 10) {
                    showModalMessage('error', 'Validation Error', 'Pan card must be 10 characters (e.g., ABCDE1234F).');
                    return false;
                }
                if (!/^[A-Z]{5}[0-9]{4}[A-Z]{1}$/.test(panValue)) {
                    showModalMessage('error', 'Validation Error', 'Invalid PAN format. Use format: ABCDE1234F');
                    return false;
                }
            }
            
            // Check if date is not in the future
            const selectedDate = new Date(date);
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            if (selectedDate > today) {
                showModalMessage('warning', 'Date Warning', 'Selected date is in the future. Please verify the date.');
                return true; // Still allow but show warning
            }
            
            return true;
        }

        /* Load data from Google Sheets */
        function loadData() {
            loadingIndicator.style.display = 'flex';
            noDataMessage.style.display = 'none';
            
            fetch(`${scriptUrl}?action=getAll&spreadsheetId=${SPREADSHEET_ID}&sheetName=${SHEET_NAME}`)
            .then(res => {
                if (!res.ok) {
                    throw new Error(`HTTP error! status: ${res.status}`);
                }
                return res.json();
            })
            .then(data => {
                console.log("Data received from Google Sheets:", data); // Debug log
                
                if (!Array.isArray(data)) {
                    throw new Error("Invalid data format received");
                }
                
                allData = data;
                totalRecordsElement.textContent = data.length;
                loadTable(data);
                loadingIndicator.style.display = 'none';
                
                if (data.length === 0) {
                    noDataMessage.style.display = 'block';
                }
            })
            .catch(error => {
                console.error('Error loading data:', error);
                loadingIndicator.style.display = 'none';
                showToast('Failed to load data. Please try again.', 'error');
                
                // Show error in console with more details
                console.error("Full error details:", error.message, error.stack);
            });
        }

        /* Load data into table */
        function loadTable(data) {
            const tbody = document.getElementById("tableBody");
            tbody.innerHTML = "";

            if (data.length === 0) {
                noDataMessage.style.display = 'block';
                return;
            } else {
                noDataMessage.style.display = 'none';
            }

            data.forEach((r, index) => {
                const tr = document.createElement("tr");
                const srNo = index + 1;

                // Debug: Log each record to see what data is available
                console.log(`Record ${index}:`, {
                    fullName: r.fullName,
                    amount: r.amount,
                    document: r.document,
                    aadhar: r.aadhar,
                    pan: r.pan,
                    fileUrl: r.fileUrl
                });

                tr.innerHTML = `
                    <td>${srNo}</td>
                    <td>${r.fullName || 'N/A'}</td>
                    <td class="amount-cell">${formatCurrency(r.amount)}</td>
                    <td class="action-cell">
                        <button class="btn-edit" data-index="${index}">
                            <i class="fas fa-edit"></i> Edit
                        </button>
                    </td>
                `;

                tr.querySelector(".btn-edit").onclick = () => openEditModal(index, r);

                tbody.appendChild(tr);
            });
        }

        /* Open edit modal */
        function openEditModal(index, record) {
            currentEditRow = index;
            
            console.log("Opening edit modal for record:", record); // Debug log
            
            // Hide all messages initially
            hideModalMessages();
            
            // Enable all buttons
            setButtonsState(true);
            
            // Show info message about Full Name being disabled
            showModalMessage('info', 'Information', 'Full Name cannot be edited as it is linked to the student\'s identity. To change the name, please delete this record and create a new one.');
            
            // Set form values
            editRowNumber.value = record.rowNumber;
            editSrNo.value = index + 1;
            
            // Format and set date
            const formattedDate = formatDateForInput(record.date);
            editDate.value = formattedDate;
            console.log("Date from record:", record.date, "Formatted:", formattedDate);
            
            editFullName.value = record.fullName || '';
            editAmount.value = record.amount || '';
            
            // Set document type
            const documentType = record.document || "Aadhar Card";
            editDocument.value = documentType;
            
            // Set document numbers - CRITICAL FIX HERE
            // Make sure we're getting data from the correct fields
            console.log("Document data from record:", {
                document: record.document,
                aadhar: record.aadhar,
                pan: record.pan,
                hasAadhar: !!record.aadhar,
                hasPan: !!record.pan
            });
            
            // Set Aadhar and Pan values
            editAadhar.value = record.aadhar || '';
            editPan.value = record.pan || '';
            
            // Show which document number field is populated
            if (record.aadhar && record.aadhar.trim()) {
                console.log("Aadhar value found:", record.aadhar);
            }
            if (record.pan && record.pan.trim()) {
                console.log("Pan value found:", record.pan);
            }
            
            // Show/hide document fields based on selected document
            toggleDocumentFields(documentType);
            
            // Set course
            populateCourseDropdown();
            editCourse.value = record.course || '';
            
            // Set file link
            if (record.fileUrl) {
                editFile.innerHTML = `<a href="${record.fileUrl}" target="_blank" class="file-link"><i class="fas fa-external-link-alt"></i> View File</a>`;
                console.log("File URL found:", record.fileUrl);
            } else {
                editFile.innerHTML = '<span style="color: var(--gray-color);">No file uploaded</span>';
            }
            
            // Show modal
            editModal.classList.add('active');
            document.body.style.overflow = 'hidden'; // Prevent scrolling
        }

        /* Close edit modal */
        function closeEditModal() {
            editModal.classList.remove('active');
            document.body.style.overflow = 'auto'; // Re-enable scrolling
        }

        /* UPDATE record */
        function updateRecord() {
            // Validate form data
            if (!validateFormData()) {
                return;
            }
            
            const rowNumber = editRowNumber.value;
            const documentType = editDocument.value;
            
            // Prepare document number data
            const aadharValue = documentType === 'Aadhar Card' ? editAadhar.value : '';
            const panValue = documentType === 'Pan Card' ? editPan.value : '';
            
            console.log("Updating record with:", {
                rowNumber,
                documentType,
                aadhar: aadharValue,
                pan: panValue,
                date: editDate.value,
                course: editCourse.value,
                amount: editAmount.value
            });
            
            // Show processing message
            showModalMessage('processing', 'Updating Record', 'Updating record details. Please wait...');
            
            // Disable buttons during processing
            setButtonsState(false);
            
            fetch(scriptUrl, {
                method: "POST",
                body: JSON.stringify({
                    action: "update",
                    spreadsheetId: SPREADSHEET_ID,
                    sheetName: SHEET_NAME,
                    folderId: FOLDER_ID,
                    rowNumber: parseInt(rowNumber),
                    formData: {
                        date: editDate.value,
                        fullName: editFullName.value,
                        course: editCourse.value,
                        amount: editAmount.value,
                        document: documentType,
                        aadhar: aadharValue,
                        pan: panValue
                    }
                })
            })
            .then(res => {
                if (!res.ok) {
                    throw new Error(`HTTP error! status: ${res.status}`);
                }
                return res.json();
            })
            .then((response) => {
                console.log("Update response:", response);
                
                if (response.status === "success" || response.status === "updated") {
                    // Show success message in modal
                    showModalMessage('update-success', 'Update Successful', 'Record has been updated successfully! The page will refresh in 2 seconds.');
                    
                    // Refresh data after update
                    setTimeout(() => {
                        closeEditModal();
                        loadData();
                    }, 2000);
                } else {
                    throw new Error(response.message || 'Update failed');
                }
            })
            .catch(error => {
                console.error('Update error:', error);
                // Re-enable buttons
                setButtonsState(true);
                showModalMessage('error', 'Update Failed', 'Failed to update record. ' + error.message);
            });
        }

        /* DELETE record */
        function deleteRecord() {
            // Show confirmation warning
            showModalMessage('warning', 'Confirm Deletion', 
                'Are you sure you want to delete this record? This action cannot be undone. Click Delete again to confirm.');
            
            // Change delete button to confirm
            deleteRecordBtn.innerHTML = '<i class="fas fa-check-circle"></i> Confirm Delete';
            deleteRecordBtn.onclick = confirmDelete;
            
            // Disable update and cancel buttons during confirmation
            updateRecordBtn.disabled = true;
            cancelEdit.disabled = true;
        }

        /* Confirm delete */
        function confirmDelete() {
            const rowNumber = editRowNumber.value;
            
            // Show processing message
            showModalMessage('processing', 'Deleting Record', 'Deleting record. Please wait...');
            
            // Disable all buttons during processing
            setButtonsState(false);
            
            fetch(scriptUrl, {
                method: "POST",
                body: JSON.stringify({
                    action: "delete",
                    spreadsheetId: SPREADSHEET_ID,
                    sheetName: SHEET_NAME,
                    rowNumber: parseInt(rowNumber)
                })
            })
            .then(res => {
                if (!res.ok) {
                    throw new Error(`HTTP error! status: ${res.status}`);
                }
                return res.json();
            })
            .then((response) => {
                console.log("Delete response:", response);
                
                if (response.status === "success" || response.status === "deleted") {
                    // Show success message in modal
                    showModalMessage('delete-success', 'Delete Successful', 'Record has been deleted successfully! The page will refresh in 2 seconds.');
                    
                    // Refresh data after delete
                    setTimeout(() => {
                        closeEditModal();
                        loadData();
                    }, 2000);
                } else {
                    throw new Error(response.message || 'Delete failed');
                }
            })
            .catch(error => {
                console.error('Delete error:', error);
                // Re-enable buttons
                setButtonsState(true);
                showModalMessage('error', 'Delete Failed', 'Failed to delete record. ' + error.message);
                
                // Reset delete button
                deleteRecordBtn.innerHTML = '<i class="fas fa-trash-alt"></i> Delete';
                deleteRecordBtn.onclick = deleteRecord;
            });
        }

        // Event listeners
        searchInput.addEventListener('input', function() {
            const searchTerm = this.value.toLowerCase();
            const filteredData = allData.filter(item => 
                item.fullName && item.fullName.toLowerCase().includes(searchTerm)
            );
            loadTable(filteredData);
        });

        // Document type change listener
        if (editDocument) {
            editDocument.addEventListener('change', function() {
                toggleDocumentFields(this.value);
            });
        }

        closeModal.addEventListener('click', closeEditModal);
        cancelEdit.addEventListener('click', closeEditModal);
        updateRecordBtn.addEventListener('click', updateRecord);
        deleteRecordBtn.addEventListener('click', deleteRecord);

        // Close modal when clicking outside
        editModal.addEventListener('click', function(e) {
            if (e.target === this) {
                closeEditModal();
            }
        });

        // Close modal with Escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape' && editModal.classList.contains('active')) {
                closeEditModal();
            }
        });

        // Initialize the page
        document.addEventListener('DOMContentLoaded', function() {
            console.log("Page loaded, initializing...");
            loadData();
            populateCourseDropdown();
            
            // Initially hide document fields
            if (aadharGroup) aadharGroup.style.display = 'none';
            if (panGroup) panGroup.style.display = 'none';
            
            // Add event listener for Aadhar field if it exists
            if (editAadhar) {
                editAadhar.addEventListener('input', function(e) {
                    let value = e.target.value.replace(/\D/g, '');
                    let formatted = '';
                    for (let i = 0; i < value.length && i < 12; i++) {
                        if (i > 0 && i % 4 === 0) formatted += ' ';
                        formatted += value[i];
                    }
                    e.target.value = formatted;
                });
            }
            
            // Add event listener for Pan field if it exists
            if (editPan) {
                editPan.addEventListener('input', function(e) {
                    let value = e.target.value.toUpperCase();
                    value = value.replace(/[^A-Z0-9]/g, '');
                    e.target.value = value;
                });
            }
        });
    </script>
</body>
</html>