<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Exam Fees Form | Premium Portal</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary: #4361ee;
            --primary-light: #4895ef;
            --primary-dark: #3a0ca3;
            --secondary: #7209b7;
            --accent: #f72585;
            --success: #4cc9f0;
            --warning: #f8961e;
            --danger: #ef233c;
            --dark: #1a1b27;
            --light: #f8f9fa;
            --gray-100: #f8f9fa;
            --gray-200: #e9ecef;
            --gray-300: #dee2e6;
            --gray-400: #ced4da;
            --gray-500: #adb5bd;
            --gray-600: #6c757d;
            --gray-700: #495057;
            --gray-800: #343a40;
            --gray-900: #212529;
            --shadow: 0 10px 40px rgba(0, 0, 0, 0.08);
            --shadow-lg: 0 20px 60px rgba(0, 0, 0, 0.15);
            --shadow-inner: inset 0 2px 4px rgba(0, 0, 0, 0.06);
            --radius: 16px;
            --radius-sm: 10px;
            --radius-lg: 24px;
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #e4e8f0 100%);
            color: var(--gray-900);
            line-height: 1.6;
            min-height: 100vh;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .container {
            width: 100%;
            max-width: 520px;
            background: white;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
            overflow: hidden;
            transition: var(--transition);
            animation: fadeIn 0.8s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .header {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            padding: 32px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M11 18c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm48 25c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm-43-7c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm63 31c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM34 90c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm56-76c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM12 86c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm28-65c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm23-11c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-6 60c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm29 22c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zM32 63c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm57-13c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-9-21c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM60 91c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM35 41c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM12 60c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2z' fill='%23ffffff' fill-opacity='0.05' fill-rule='evenodd'/%3E%3C/svg%3E");
            opacity: 0.3;
        }

        .header-content {
            position: relative;
            z-index: 2;
        }

        .logo {
            width: 70px;
            height: 70px;
            background: rgba(255, 255, 255, 0.15);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 20px;
            font-size: 28px;
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255, 255, 255, 0.2);
        }

        .header h1 {
            font-size: 28px;
            font-weight: 800;
            margin-bottom: 8px;
            letter-spacing: -0.5px;
        }

        .header p {
            font-size: 15px;
            opacity: 0.9;
            font-weight: 400;
            max-width: 400px;
            margin: 0 auto;
        }

        .form-container {
            padding: 36px;
        }

        .form-group {
            margin-bottom: 24px;
            position: relative;
        }

        .form-label {
            display: flex;
            align-items: center;
            font-weight: 600;
            margin-bottom: 10px;
            color: var(--gray-800);
            font-size: 15px;
            transition: var(--transition);
        }

        .form-label i {
            margin-right: 10px;
            color: var(--primary);
            width: 20px;
            text-align: center;
            font-size: 16px;
        }

        .required::after {
            content: "*";
            color: var(--danger);
            margin-left: 4px;
        }

        .form-control {
            width: 100%;
            padding: 16px 20px;
            border: 2px solid var(--gray-200);
            border-radius: var(--radius);
            font-family: 'Inter', sans-serif;
            font-size: 15px;
            font-weight: 500;
            transition: var(--transition);
            background: white;
            color: var(--gray-900);
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(67, 97, 238, 0.15);
            transform: translateY(-1px);
        }

        .form-control::placeholder {
            color: var(--gray-500);
            font-weight: 400;
        }

        .form-control:disabled {
            background: var(--gray-100);
            cursor: not-allowed;
            opacity: 0.7;
        }

        .form-hint {
            font-size: 12px;
            color: var(--gray-600);
            margin-top: 5px;
            font-style: italic;
        }

        /* Custom Dropdown */
        .custom-dropdown {
            position: relative;
            width: 100%;
        }

        .dropdown-trigger {
            width: 100%;
            padding: 16px 20px;
            border: 2px solid var(--gray-200);
            border-radius: var(--radius);
            background: white;
            text-align: left;
            cursor: pointer;
            position: relative;
            font-size: 15px;
            font-weight: 500;
            color: var(--gray-900);
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: space-between;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .dropdown-trigger:hover {
            border-color: var(--gray-300);
        }

        .dropdown-trigger:active {
            transform: translateY(1px);
        }

        .dropdown-trigger i {
            color: var(--gray-600);
            transition: var(--transition);
            flex-shrink: 0;
            margin-left: 10px;
        }

        .dropdown-trigger.active i {
            transform: rotate(180deg);
            color: var(--primary);
        }

        .dropdown-placeholder {
            color: var(--gray-500);
            font-weight: 400;
        }

        .dropdown-value {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            flex-grow: 1;
        }

        /* Popup Styles */
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
            z-index: 1000;
            display: none;
            animation: fadeInOverlay 0.3s ease-out;
        }

        @keyframes fadeInOverlay {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .overlay.active {
            display: block;
        }

        .dropdown-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.95);
            background: white;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
            z-index: 1001;
            width: 90%;
            max-width: 450px;
            max-height: 80vh;
            overflow: hidden;
            opacity: 0;
            visibility: hidden;
            transition: var(--transition);
        }

        .dropdown-popup.active {
            opacity: 1;
            visibility: visible;
            transform: translate(-50%, -50%) scale(1);
        }

        .dropdown-header {
            padding: 24px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .dropdown-header h3 {
            font-size: 20px;
            font-weight: 700;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .dropdown-header h3 i {
            font-size: 18px;
        }

        .close-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition);
            font-size: 20px;
            padding: 0;
        }

        .close-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: rotate(90deg);
        }

        .search-box {
            padding: 20px 24px;
            border-bottom: 1px solid var(--gray-200);
            position: relative;
        }

        .search-box i {
            position: absolute;
            left: 40px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--gray-500);
            font-size: 16px;
        }

        .search-box input {
            width: 100%;
            padding: 14px 20px 14px 46px;
            border: 2px solid var(--gray-200);
            border-radius: var(--radius);
            font-family: 'Inter', sans-serif;
            font-size: 15px;
            font-weight: 500;
            transition: var(--transition);
            background: var(--gray-100);
        }

        .search-box input:focus {
            outline: none;
            border-color: var(--primary);
            background: white;
            box-shadow: 0 0 0 4px rgba(67, 97, 238, 0.1);
        }

        .options-container {
            max-height: 350px;
            overflow-y: auto;
            padding: 0;
        }

        .option-item {
            padding: 16px 24px;
            border-bottom: 1px solid var(--gray-100);
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .option-item:last-child {
            border-bottom: none;
        }

        .option-item:hover {
            background: var(--gray-50);
            padding-left: 30px;
        }

        .option-item.selected {
            background: linear-gradient(90deg, rgba(67, 97, 238, 0.1), rgba(67, 97, 238, 0.05));
            color: var(--primary);
            font-weight: 600;
            border-left: 4px solid var(--primary);
        }

        .option-item.selected i {
            color: var(--primary);
        }

        .option-item i {
            color: var(--gray-500);
            font-size: 14px;
            opacity: 0;
            transition: var(--transition);
        }

        .option-item.selected i {
            opacity: 1;
        }

        .no-results {
            padding: 40px 24px;
            text-align: center;
            color: var(--gray-500);
            font-style: italic;
        }

        .no-results i {
            font-size: 32px;
            margin-bottom: 12px;
            color: var(--gray-400);
        }

        /* File Upload Styling */
        .file-upload-container {
            border: 2px dashed var(--gray-300);
            border-radius: var(--radius);
            padding: 24px;
            text-align: center;
            background: var(--gray-100);
            transition: var(--transition);
            cursor: pointer;
        }

        .file-upload-container:hover {
            border-color: var(--primary);
            background: rgba(67, 97, 238, 0.03);
        }

        .file-upload-container.active {
            border-color: var(--success);
            background: rgba(76, 201, 240, 0.05);
        }

        .file-upload-icon {
            font-size: 32px;
            color: var(--primary);
            margin-bottom: 12px;
        }

        .file-upload-text {
            font-weight: 600;
            margin-bottom: 6px;
            color: var(--gray-800);
        }

        .file-upload-hint {
            font-size: 13px;
            color: var(--gray-600);
            margin-bottom: 12px;
        }

        .file-info {
            font-size: 14px;
            color: var(--gray-700);
            margin-top: 12px;
            padding: 12px;
            background: white;
            border-radius: var(--radius-sm);
            border: 1px solid var(--gray-200);
            display: flex;
            align-items: center;
            justify-content: space-between;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .file-info i {
            color: var(--success);
        }

        .remove-file {
            color: var(--danger);
            background: none;
            border: none;
            cursor: pointer;
            font-size: 14px;
            padding: 4px 8px;
            border-radius: var(--radius-sm);
            transition: var(--transition);
        }

        .remove-file:hover {
            background: rgba(239, 35, 60, 0.1);
        }

        /* Submit Button */
        .btn-submit {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            border: none;
            border-radius: var(--radius);
            padding: 18px;
            font-family: 'Inter', sans-serif;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100%;
            margin-top: 10px;
            letter-spacing: 0.5px;
            position: relative;
            overflow: hidden;
        }

        .btn-submit::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: 0.5s;
        }

        .btn-submit:hover::before {
            left: 100%;
        }

        .btn-submit:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(67, 97, 238, 0.3);
        }

        .btn-submit:active {
            transform: translateY(-1px);
        }

        .btn-submit:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn-submit i {
            margin-right: 10px;
            font-size: 18px;
        }

        /* Status Messages */
        #status {
            margin-top: 24px;
            padding: 18px;
            border-radius: var(--radius);
            text-align: center;
            font-weight: 600;
            display: none;
            animation: fadeIn 0.5s ease-out;
            align-items: center;
            justify-content: center;
            gap: 12px;
        }

        .status-success {
            background: linear-gradient(135deg, rgba(76, 201, 240, 0.15), rgba(76, 201, 240, 0.05));
            color: #0a9396;
            border: 2px solid rgba(76, 201, 240, 0.3);
        }

        .status-error {
            background: linear-gradient(135deg, rgba(239, 35, 60, 0.1), rgba(239, 35, 60, 0.05));
            color: var(--danger);
            border: 2px solid rgba(239, 35, 60, 0.3);
        }

        .status-loading {
            background: linear-gradient(135deg, rgba(67, 97, 238, 0.1), rgba(67, 97, 238, 0.05));
            color: var(--primary);
            border: 2px solid rgba(67, 97, 238, 0.3);
        }

        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Footer */
        .footer {
            text-align: center;
            padding: 24px 36px;
            font-size: 13px;
            color: var(--gray-600);
            border-top: 1px solid var(--gray-200);
            background: var(--gray-100);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .footer i {
            color: var(--success);
        }

        /* Responsive Styles */
        @media (max-width: 768px) {
            body {
                padding: 15px;
            }
            
            .container {
                max-width: 100%;
                margin: 0;
                border-radius: var(--radius);
            }
            
            .header {
                padding: 28px 24px;
            }
            
            .header h1 {
                font-size: 24px;
            }
            
            .form-container {
                padding: 28px 24px;
            }
            
            .form-group {
                margin-bottom: 20px;
            }
            
            .dropdown-popup {
                width: 95%;
                max-height: 70vh;
            }
            
            .options-container {
                max-height: 300px;
            }
        }

        @media (max-width: 480px) {
            body {
                padding: 10px;
            }
            
            .container {
                border-radius: 20px;
            }
            
            .header {
                padding: 24px 20px;
            }
            
            .logo {
                width: 60px;
                height: 60px;
                font-size: 24px;
            }
            
            .header h1 {
                font-size: 22px;
            }
            
            .header p {
                font-size: 14px;
            }
            
            .form-container {
                padding: 24px 20px;
            }
            
            .form-control, .dropdown-trigger {
                padding: 14px 18px;
            }
            
            .dropdown-header {
                padding: 20px;
            }
            
            .search-box {
                padding: 16px 20px;
            }
            
            .option-item {
                padding: 14px 20px;
            }
            
            .btn-submit {
                padding: 16px;
            }
            
            .footer {
                padding: 20px;
                font-size: 12px;
            }
        }

        /* Custom scrollbar */
        .options-container::-webkit-scrollbar {
            width: 6px;
        }

        .options-container::-webkit-scrollbar-track {
            background: var(--gray-100);
        }

        .options-container::-webkit-scrollbar-thumb {
            background: var(--gray-400);
            border-radius: 10px;
        }

        .options-container::-webkit-scrollbar-thumb:hover {
            background: var(--gray-500);
        }
    </style>
</head>

<body>

<div class="overlay" id="overlay"></div>

<div class="container">
    <div class="header">
        <div class="header-content">
            <div class="logo">
                <i class="fas fa-graduation-cap"></i>
            </div>
            <h1>Exam Fees Portal</h1>
            <p>Submit your examination fee details securely with our premium portal</p>
        </div>
    </div>
    
    <div class="form-container">
        <div class="form-group">
            <label class="form-label required">
                <i class="fas fa-calendar-day"></i> Date
            </label>
            <input type="date" id="date" class="form-control">
        </div>
        
        <div class="form-group">
            <label class="form-label required">
                <i class="fas fa-user-graduate"></i> Full Name
            </label>
            <div class="custom-dropdown">
                <div class="dropdown-trigger" id="fullNameTrigger">
                    <span class="dropdown-value">Select student name</span>
                    <i class="fas fa-chevron-down"></i>
                </div>
            </div>
            <!-- Hidden select for clean data -->
            <select id="fullName" style="display: none;"></select>
        </div>
        
        <div class="form-group">
            <label class="form-label required">
                <i class="fas fa-book-open"></i> Exam for Course
            </label>
            <div class="custom-dropdown">
                <div class="dropdown-trigger" id="courseTrigger">
                    <span class="dropdown-value">Select course</span>
                    <i class="fas fa-chevron-down"></i>
                </div>
            </div>
            <!-- Hidden select for clean data -->
            <select id="course" style="display: none;">
                <option value="PC Operation (Basic)">PC Operation (Basic)</option>
                <option value="Tally with GST">Tally with GST</option>
                <option value="Advance Excel">Advance Excel</option>
                <option value="Basic + Tally">Basic + Tally</option>
                <option value="Basic + Advance Excel">Basic + Advance Excel</option>
                <option value="Tally + Advance Excel">Tally + Advance Excel</option>
            </select>
        </div>
        
        <div class="form-group">
            <label class="form-label required">
                <i class="fas fa-rupee-sign"></i> Amount
            </label>
            <input type="number" id="amount" class="form-control" placeholder="Enter fee amount">
        </div>
        
        <div class="form-group">
            <label class="form-label required">
                <i class="fas fa-file-certificate"></i> Document Name
            </label>
            <select id="documentName" class="form-control">
			    <option value="">Select Documents</option>
                <option value="Aadhar Card">Aadhar Card</option>
                <option value="Pan Card">Pan Card</option>
                <option value="Passport">Passport</option>
                <option value="Driving License">Driving License</option>
            </select>
        </div>
        
        <!-- Aadhar Card Number Field (Initially hidden) -->
        <div class="form-group" id="aadharGroup" style="display: none;">
            <label class="form-label required">
                <i class="fas fa-id-card"></i> Aadhar Card No:
            </label>
            <input type="text" id="aadharNumber" class="form-control" 
                   placeholder="Enter Aadhar card No (XXXX XXXX XXXX format)"
                   maxlength="14">
            <div class="form-hint">Format: 1234 5678 9012 (12 digits)</div>
        </div>
        
        <!-- Pan Card Number Field (Initially hidden) -->
        <div class="form-group" id="panGroup" style="display: none;">
            <label class="form-label required">
                <i class="fas fa-credit-card"></i> Pan Card No:
            </label>
            <input type="text" id="panNumber" class="form-control" 
                   placeholder="Enter your pan card number"
                   maxlength="10">
            <div class="form-hint">Format: ABCDE1234F (10 characters)</div>
        </div>
        
        <div class="form-group">
            <label class="form-label required">
                <i class="fas fa-cloud-upload-alt"></i> Upload Document
            </label>
            <div class="file-upload-container" id="fileUploadContainer">
                <div class="file-upload-icon">
                    <i class="fas fa-file-upload"></i>
                </div>
                <div class="file-upload-text">Click to upload document</div>
                <div class="file-upload-hint">PDF, JPG, PNG files up to 5MB</div>
                <input type="file" id="fileInput" accept=".pdf,.jpg,.png" style="display: none;">
            </div>
            <div id="fileInfo" class="file-info" style="display: none;"></div>
        </div>
        
        <button id="submitBtn" class="btn-submit" onclick="submitForm()">
            <i class="fas fa-paper-plane"></i> Submit Fee Details
        </button>
        
        <div id="status"></div>
    </div>
    
    <div class="footer">
        <i class="fas fa-shield-alt"></i>
        <span>Secured with end-to-end encryption â€¢ All data is protected</span>
    </div>
</div>

<!-- Searchable Popup -->
<div class="dropdown-popup" id="searchPopup">
    <div class="dropdown-header">
        <h3 id="popupTitle"><i class="fas fa-search"></i> Search Options</h3>
        <button class="close-btn" onclick="closePopup()">&times;</button>
    </div>
    <div class="search-box">
        <i class="fas fa-search"></i>
        <input type="text" id="searchInput" placeholder="Type to search options..." autocomplete="off">
    </div>
    <div class="options-container" id="optionsList">
        <!-- Options will be dynamically added here -->
    </div>
</div>

<script>
/* ðŸ”§ CONFIG (CHANGE ONLY HERE) */
const scriptUrl = "https://script.google.com/macros/s/AKfycbylbF6GepY2XkkoVfPW-tW9aoJa6Ok86ciQMUPtJY328KcOYVckziNJBkiWSYwmnjTu/exec";

const FOLDER_ID = "1wzQqQkGNUa9yuxsJn9CXGNVmSu0IdbNL";
const SPREADSHEET_ID = "17W3uI55kaecrshN3k5Fsd7XjMtsJeQen5GiSiz4qZis";
const SHEET_NAME = "Exam_Fees_details";

const SOURCE_SHEET_ID = "1rDjeUVYtneVzA6d8-VwyoZ8B8w1MHDxG-vlgN3O2c-0";
const SOURCE_SHEET_NAME = "Computer";
/* ============================ */

// Global variables
let currentDropdownType = '';
let allNames = [];
let allCourses = [
    "PC Operation (Basic)",
    "Tally with GST",
    "Advance Excel",
    "Basic + Tally",
    "Basic + Advance Excel",
    "Tally + Advance Excel"
];

// Helper function to clean data - removes extra spaces, line breaks
function cleanData(value) {
    if (!value) return '';
    return value.toString()
        .trim() // Remove leading/trailing spaces
        .replace(/\s+/g, ' ') // Replace multiple spaces with single space
        .replace(/\n/g, ' ') // Replace line breaks with spaces
        .replace(/\r/g, '') // Remove carriage returns
        .replace(/\t/g, ' '); // Replace tabs with spaces
}

// Initialize the form
document.addEventListener('DOMContentLoaded', function() {
    // Autofill Date with today's date
    const today = new Date().toISOString().split("T")[0];
    document.getElementById("date").value = today;
    
    // Load student names from API
    loadNames();
    
    // Setup dropdown triggers
    document.getElementById('fullNameTrigger').addEventListener('click', function() {
        openSearchPopup('name', 'Search Student Name', allNames, this);
    });
    
    document.getElementById('courseTrigger').addEventListener('click', function() {
        openSearchPopup('course', 'Search Course', allCourses, this);
    });
    
    // Setup search functionality
    document.getElementById('searchInput').addEventListener('input', filterOptions);
    
    // Document type change handler for showing/hiding number fields
    document.getElementById('documentName').addEventListener('change', function() {
        const selectedDoc = this.value;
        const aadharGroup = document.getElementById('aadharGroup');
        const panGroup = document.getElementById('panGroup');
        const aadharInput = document.getElementById('aadharNumber');
        const panInput = document.getElementById('panNumber');
        
        // Hide both initially
        aadharGroup.style.display = 'none';
        panGroup.style.display = 'none';
        
        // Clear previous values
        aadharInput.value = '';
        panInput.value = '';
        
        // Show relevant field based on selection
        if (selectedDoc === 'Aadhar Card') {
            aadharGroup.style.display = 'block';
            setTimeout(() => aadharInput.focus(), 100);
        } else if (selectedDoc === 'Pan Card') {
            panGroup.style.display = 'block';
            setTimeout(() => panInput.focus(), 100);
        }
        // For Passport and Driving License, no additional fields needed
    });
    
    // Aadhar number formatting (XXXX XXXX XXXX)
    document.getElementById('aadharNumber').addEventListener('input', function(e) {
        let value = e.target.value.replace(/\D/g, ''); // Remove non-digits
        let formatted = '';
        
        // Format as XXXX XXXX XXXX
        for (let i = 0; i < value.length && i < 12; i++) {
            if (i > 0 && i % 4 === 0) {
                formatted += ' ';
            }
            formatted += value[i];
        }
        
        e.target.value = formatted;
    });
    
    // Pan number validation (uppercase letters + numbers)
    document.getElementById('panNumber').addEventListener('input', function(e) {
        let value = e.target.value.toUpperCase(); // Convert to uppercase
        value = value.replace(/[^A-Z0-9]/g, ''); // Remove non-alphanumeric
        e.target.value = value;
    });
    
    // File upload handling
    const fileUploadContainer = document.getElementById('fileUploadContainer');
    const fileInput = document.getElementById('fileInput');
    const fileInfo = document.getElementById('fileInfo');
    
    fileUploadContainer.addEventListener('click', () => fileInput.click());
    
    fileInput.addEventListener('change', function() {
        if (this.files.length > 0) {
            const file = this.files[0];
            const fileSize = (file.size / (1024 * 1024)).toFixed(2);
            
            fileInfo.innerHTML = `
                <div>
                    <i class="fas fa-check-circle"></i>
                    <strong>${file.name}</strong> (${fileSize} MB)
                </div>
                <button class="remove-file" onclick="removeFile()">
                    <i class="fas fa-times"></i> Remove
                </button>
            `;
            fileInfo.style.display = 'flex';
            
            fileUploadContainer.classList.add('active');
            fileUploadContainer.querySelector('.file-upload-icon').innerHTML = '<i class="fas fa-file-check"></i>';
            fileUploadContainer.querySelector('.file-upload-text').textContent = 'Document selected';
            
            // Validate file type
            if (!["application/pdf","image/png","image/jpeg"].includes(file.type)) {
                showStatus("Only PDF, JPG, PNG files are allowed", "error");
                removeFile();
            }
            
            // Validate file size
            if (file.size > 5 * 1024 * 1024) {
                showStatus("File must be under 5MB", "error");
                removeFile();
            }
        }
    });
    
    // Close popup with Escape key
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && document.getElementById('overlay').classList.contains('active')) {
            closePopup();
        }
    });
    
    // Close popup when clicking overlay
    document.getElementById('overlay').addEventListener('click', closePopup);
});

// Load names from API
function loadNames() {
    const statusDiv = document.getElementById("status");
    statusDiv.style.display = "block";
    statusDiv.className = "status-loading";
    statusDiv.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Loading student names...';
    
    fetch(`${scriptUrl}?sourceSheetId=${SOURCE_SHEET_ID}&sourceSheetName=${SOURCE_SHEET_NAME}`)
      .then(res => res.json())
      .then(names => {
          // Clean names - remove any extra spaces or line breaks
          allNames = names.map(name => cleanData(name));
          
          // Also populate the hidden select element for form submission
          const select = document.getElementById("fullName");
          select.innerHTML = ''; // Clear existing options
          allNames.forEach(n => {
              const opt = document.createElement("option");
              opt.value = n;
              opt.textContent = n;
              select.appendChild(opt);
          });
          
          statusDiv.style.display = "none";
      })
      .catch(err => {
          console.error("Error loading names:", err);
          // Fallback names (already cleaned)
          allNames = [
              "Aarav Sharma", "Vivaan Patel", "Aditya Singh", "Vihaan Kumar", 
              "Arjun Mehta", "Sai Reddy", "Reyansh Gupta", "Mohammed Khan", 
              "Ishaan Sharma", "Kabir Verma", "Ananya Patel", "Aadhya Singh", 
              "Diya Kumar", "Anika Reddy", "Sara Gupta", "Myra Khan"
          ];
          
          const select = document.getElementById("fullName");
          select.innerHTML = ''; // Clear existing options
          allNames.forEach(n => {
              const opt = document.createElement("option");
              opt.value = n;
              opt.textContent = n;
              select.appendChild(opt);
          });
          
          statusDiv.style.display = "none";
      });
}

// Open searchable popup
function openSearchPopup(type, title, options, triggerElement) {
    currentDropdownType = type;
    document.getElementById('popupTitle').innerHTML = `<i class="fas fa-search"></i> ${title}`;
    
    // Store the trigger element for later reference
    window.currentTrigger = triggerElement;
    window.currentTrigger.classList.add('active');
    
    // Store all options for this dropdown (already cleaned)
    window.currentOptions = options;
    
    // Populate options
    populateOptions(options);
    
    // Show popup and overlay
    document.getElementById('searchPopup').classList.add('active');
    document.getElementById('overlay').classList.add('active');
    
    // Focus search input
    setTimeout(() => {
        document.getElementById('searchInput').focus();
    }, 100);
}

// Close popup
function closePopup() {
    document.getElementById('searchPopup').classList.remove('active');
    document.getElementById('overlay').classList.remove('active');
    document.getElementById('searchInput').value = '';
    
    if (window.currentTrigger) {
        window.currentTrigger.classList.remove('active');
    }
}

// Populate options in the popup
function populateOptions(options) {
    const optionsList = document.getElementById('optionsList');
    optionsList.innerHTML = '';
    
    if (options.length === 0) {
        optionsList.innerHTML = `
            <div class="no-results">
                <i class="fas fa-search"></i>
                <div>No matching options found</div>
            </div>
        `;
        return;
    }
    
    options.forEach(option => {
        const optionElement = document.createElement('div');
        optionElement.className = 'option-item';
        optionElement.innerHTML = `
            <span>${option}</span>
            <i class="fas fa-check"></i>
        `;
        optionElement.dataset.value = option;
        
        // Check if this option is currently selected
        const triggerValueSpan = window.currentTrigger.querySelector('.dropdown-value');
        const triggerText = triggerValueSpan ? triggerValueSpan.textContent : window.currentTrigger.textContent;
        const cleanTriggerText = cleanData(triggerText);
        
        if (cleanTriggerText === option) {
            optionElement.classList.add('selected');
        }
        
        optionElement.addEventListener('click', function() {
            selectOption(option);
        });
        
        optionsList.appendChild(optionElement);
    });
}

// Filter options based on search input
function filterOptions() {
    const searchTerm = cleanData(document.getElementById('searchInput').value).toLowerCase();
    const filteredOptions = window.currentOptions.filter(option => 
        option.toLowerCase().includes(searchTerm)
    );
    
    populateOptions(filteredOptions);
}

// Select an option from the popup
function selectOption(selectedValue) {
    // Clean the selected value
    const cleanValue = cleanData(selectedValue);
    
    // Update the trigger button text
    if (window.currentTrigger) {
        const valueSpan = window.currentTrigger.querySelector('.dropdown-value');
        if (valueSpan) {
            valueSpan.textContent = cleanValue;
            valueSpan.title = cleanValue; // Add tooltip for overflow
        } else {
            window.currentTrigger.textContent = cleanValue;
        }
        
        // Also update the corresponding hidden select element with clean value
        if (currentDropdownType === 'name') {
            document.getElementById('fullName').value = cleanValue;
        } else if (currentDropdownType === 'course') {
            document.getElementById('course').value = cleanValue;
        }
    }
    
    closePopup();
}

// Remove selected file
function removeFile() {
    document.getElementById('fileInput').value = '';
    document.getElementById('fileInfo').style.display = 'none';
    document.getElementById('fileUploadContainer').classList.remove('active');
    document.getElementById('fileUploadContainer').querySelector('.file-upload-icon').innerHTML = '<i class="fas fa-file-upload"></i>';
    document.getElementById('fileUploadContainer').querySelector('.file-upload-text').textContent = 'Click to upload document';
}

// Show status message
function showStatus(message, type) {
    const statusDiv = document.getElementById("status");
    statusDiv.style.display = "flex";
    statusDiv.className = type === "error" ? "status-error" : "status-success";
    
    if (type === "error") {
        statusDiv.innerHTML = `<i class="fas fa-exclamation-circle"></i> ${message}`;
    } else if (type === "success") {
        statusDiv.innerHTML = `<i class="fas fa-check-circle"></i> ${message}`;
    }
    
    // Auto hide success messages after 5 seconds, error after 8 seconds
    const hideTime = type === "error" ? 8000 : 5000;
    setTimeout(() => {
        statusDiv.style.display = "none";
    }, hideTime);
}

// Submit form function - UPDATED for Google Sheets column mapping
function submitForm() {
    const dateField = document.getElementById("date");
    const fullNameSelect = document.getElementById("fullName");
    const courseSelect = document.getElementById("course");
    const amountField = document.getElementById("amount");
    const documentField = document.getElementById("documentName");
    const aadharInput = document.getElementById("aadharNumber");
    const panInput = document.getElementById("panNumber");
    const fileInput = document.getElementById("fileInput");
    const submitBtn = document.getElementById("submitBtn");
    const originalBtnText = submitBtn.innerHTML;

    // Get selected values from hidden select elements (already cleaned)
    const selectedName = cleanData(fullNameSelect.value);
    const selectedCourse = cleanData(courseSelect.value);
    const selectedDoc = cleanData(documentField.value);
    
    // Also check dropdown display values for validation
    const fullNameTrigger = document.getElementById("fullNameTrigger");
    const courseTrigger = document.getElementById("courseTrigger");
    const displayName = cleanData(fullNameTrigger.querySelector('.dropdown-value').textContent);
    const displayCourse = cleanData(courseTrigger.querySelector('.dropdown-value').textContent);

    // Validate form
    if (!dateField.value) {
        showStatus("Please select a date", "error");
        dateField.focus();
        return;
    }
    
    if (!selectedName || displayName === "Select student name") {
        showStatus("Please select your name", "error");
        document.getElementById('fullNameTrigger').click();
        return;
    }
    
    if (!selectedCourse || displayCourse === "Select course") {
        showStatus("Please select a course", "error");
        document.getElementById('courseTrigger').click();
        return;
    }

    if (!amountField.value || amountField.value <= 0) {
        showStatus("Please enter a valid amount", "error");
        amountField.focus();
        return;
    }

    // Validate document number based on selected document
    if (selectedDoc === 'Aadhar Card') {
        const aadharValue = aadharInput.value.replace(/\s/g, ''); // Remove spaces for validation
        if (!aadharValue || aadharValue.length !== 12) {
            showStatus("Aadhar card must be 12 digits in XXXX XXXX XXXX format", "error");
            aadharInput.focus();
            return;
        }
        if (!/^\d+$/.test(aadharValue)) {
            showStatus("Aadhar card must contain only numbers", "error");
            aadharInput.focus();
            return;
        }
    } else if (selectedDoc === 'Pan Card') {
        const panValue = panInput.value;
        if (!panValue || panValue.length !== 10) {
            showStatus("Pan card must be 10 characters (e.g., ABCDE1234F)", "error");
            panInput.focus();
            return;
        }
        if (!/^[A-Z]{5}[0-9]{4}[A-Z]{1}$/.test(panValue)) {
            showStatus("Invalid PAN format. Use format: ABCDE1234F", "error");
            panInput.focus();
            return;
        }
    }

    const file = fileInput.files[0];
    if (!file) {
        showStatus("Please upload a document", "error");
        return;
    }

    if (!["application/pdf","image/png","image/jpeg"].includes(file.type)) {
        showStatus("Only PDF, JPG, PNG files are allowed", "error");
        removeFile();
        return;
    }

    if (file.size > 5 * 1024 * 1024) {
        showStatus("File must be under 5MB", "error");
        removeFile();
        return;
    }

    // Show loading state
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
    submitBtn.disabled = true;
    
    showStatus("Uploading document and processing your submission...", "loading");

    const reader = new FileReader();
    reader.onload = function() {
        // Prepare payload according to Google Sheets column mapping:
        // A: Date, B: Full Name, C: Course, D: Amount, E: Document Name
        // F: Aadhar Card No, G: Pan Card No, H: File URL
        const payload = {
            folderId: FOLDER_ID,
            spreadsheetId: SPREADSHEET_ID,
            sheetName: SHEET_NAME,
            fileName: cleanData(file.name),
            fileType: file.type,
            fileBase64: reader.result.split(",")[1],
            action: "add",
            formData: {
                // Column A in Google Sheets
                date: cleanData(dateField.value),
                
                // Column B in Google Sheets
                fullName: selectedName,
                
                // Column C in Google Sheets
                course: selectedCourse,
                
                // Column D in Google Sheets
                amount: cleanData(amountField.value),
                
                // Column E in Google Sheets
                document: selectedDoc,
                
                // Column F in Google Sheets (Aadhar Card No)
                // Send empty string if not Aadhar Card
                aadhar: selectedDoc === 'Aadhar Card' ? cleanData(aadharInput.value) : '',
                
                // Column G in Google Sheets (Pan Card No)
                // Send empty string if not Pan Card
                pan: selectedDoc === 'Pan Card' ? cleanData(panInput.value) : ''
                
                // Column H (File URL) will be generated by Google Apps Script
            }
        };

        // Debug log to verify data structure
        console.log("Sending data to Google Sheets:", {
            date: payload.formData.date,
            fullName: payload.formData.fullName,
            course: payload.formData.course,
            amount: payload.formData.amount,
            document: payload.formData.document,
            aadhar: payload.formData.aadhar,
            pan: payload.formData.pan,
            fileName: payload.fileName
        });

        // Send data to Google Apps Script
        fetch(scriptUrl, {
            method: "POST",
            body: JSON.stringify(payload)
        })
        .then(res => {
            if (!res.ok) {
                throw new Error(`HTTP error! status: ${res.status}`);
            }
            return res.json();
        })
        .then(data => {
            if (data.status === "success") {
                // Success
                submitBtn.innerHTML = '<i class="fas fa-check"></i> Successfully Submitted!';
                submitBtn.style.background = "linear-gradient(135deg, #4cc9f0, #4895ef)";
                
                showStatus("Your exam fee details have been submitted successfully!", "success");
                
                // Reset form after 3 seconds
                setTimeout(() => {
                    submitBtn.innerHTML = originalBtnText;
                    submitBtn.disabled = false;
                    submitBtn.style.background = "linear-gradient(135deg, var(--primary), var(--secondary))";
                    
                    // Clear form
                    amountField.value = "";
                    removeFile();
                    documentField.value = "Aadhar Card";
                    
                    // Reset document number fields
                    aadharInput.value = "";
                    panInput.value = "";
                    document.getElementById('aadharGroup').style.display = 'none';
                    document.getElementById('panGroup').style.display = 'none';
                    
                    // Reset dropdowns
                    fullNameTrigger.querySelector('.dropdown-value').textContent = "Select student name";
                    courseTrigger.querySelector('.dropdown-value').textContent = "Select course";
                    
                    // Reset hidden selects
                    fullNameSelect.value = "";
                    courseSelect.value = "";
                    
                    // Reset date to today
                    const today = new Date().toISOString().split("T")[0];
                    dateField.value = today;
                    
                    // Clear any validation errors
                    showStatus("", "success");
                }, 3000);
            } else {
                submitBtn.innerHTML = originalBtnText;
                submitBtn.disabled = false;
                
                showStatus("Submission Failed: " + (data.message || "Unknown error"), "error");
            }
        })
        .catch(err => {
            console.error("Submission Error:", err);
            submitBtn.innerHTML = originalBtnText;
            submitBtn.disabled = false;
            
            showStatus("Network Error: Please check your connection and try again", "error");
        });
    };
    
    reader.onerror = function() {
        submitBtn.innerHTML = originalBtnText;
        submitBtn.disabled = false;
        
        showStatus("Error reading file. Please try again.", "error");
    };
    
    reader.readAsDataURL(file);
}
</script>

</body>
</html>